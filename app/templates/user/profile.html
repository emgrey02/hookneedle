{% extends 'base.html' %}
{% block header %}
    {% block title %}Profile{% endblock %}
{% endblock %}
{% block content %}
    <div class="flex w-full justify-end gap-4">
        <!-- if this user profile is the current user's profile -->
        {% if g.user['id'] == thisUser.id %}
            <a class="button" href="{{ url_for('user.edit', id=thisUser.id) }}">Update Profile</a>
            <!-- this is another user's profile -->
        {% else %}
            <!-- if logged in user is friends with this user -->
            {% if friendship %}
                <div class="text-green-500">✓ Your Friend!</div>
                <!-- if there is a request between logged in user and this user -->
            {% elif request %}
                {% if (request['user1_id'] == thisUser.id) %}
                    <button id="add-friend" class="button is-secondary">Accept Friend Request</button>
                {% elif (request['user1_id'] == g.user['id']) %}
                    <div class="text-yellow-400">✓ Friendship Requested</div>
                {% endif %}
            {% else %}
                <button id="add-friend" class="button">Add Friend</button>
            {% endif %}
        {% endif %}
    </div>
    <div class="flex flex-col gap-4">
        <h2>{{ thisUser.username }}</h2>
        <div class="img-ctn">
            {% if not profile['image_data'] %}
                <div class="bg-gray-700 w-full h-full grid place-items-center">
                    <img height="400"
                         width="400"
                         src="{{ url_for('static', filename='logo.svg') }}"
                         alt="hookneedle logo because no image available" />
                </div>
            {% else %}
                <img height="400"
                     width="400"
                     src="{{ profile['image_data'] }}"
                     alt="image of {{ thisUser.username }}" />
            {% endif %}
        </div>
        <div>
            <h3>Bio</h3>
            {% if profile.bio %}
                <p>{{ profile.bio }}</p>
            {% else %}
                <p>n/a</p>
            {% endif %}
        </div>
        {% if projects %}
            <div>
                <h3>PROJECTS</h3>
                <ul>
                    {% for project in projects %}
                        <li>
                            <a class="link" href="/project/{{ project.id }}">{{ project.name }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% if userFriends %}
            <div>
                <h3>Friends</h3>
                <ul>
                    {% for friend in userFriends %}
                        <li>
                            <a class="link" href='/user/profile/{{ friend["friendId"] }}'>{{ friend.friendUsername }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    </div>
    <script>
	document.addEventListener('DOMContentLoaded', () => {
		friendId = '{{ thisUser.id }}';

		addFriendBtn = document.querySelector('#add-friend');

		addFriendBtn?.addEventListener('click', () => {
			fetch(`/user/addfriend/${friendId}`, {
				method: 'POST',
			}).then(()=> window.location.replace(`/user/profile/${friendId}`)).catch((error) => console.error('CAUGHT ERROR ON POST', error));
		});
	});
    </script>
{% endblock %}
