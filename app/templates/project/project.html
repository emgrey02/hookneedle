{% extends 'base.html' %}
{% block header %}
    {% block title %}{{ project['name'] }}{% endblock %}
{% endblock %}
{% block content %}
    {% if g.user['id'] !=
        project['user_id'] %}
        <div class="text-center mb-8">
            by
            <a class="link"
               href="{{ url_for('user.profile', id=project['user_id']) }}">{{ project['username'] }}</a>
        </div>
    {% endif %}
    {% if g.user['id'] == project['user_id'] %}
        <div class="flex w-full justify-center sm:justify-end gap-4">
            <a class="button" href="{{ url_for('project.edit', id=project['id']) }}">Edit Project Info</a>
            <button id="delete-btn" class="button is-danger">Delete Project</button>
        </div>
    {% endif %}
    <div class="grid grid-cols-1 sm:grid-cols-[300px_1fr] gap-4">
        <div class="flex flex-col gap-2">
            <div class="img-ctn w-[300px] h-[300px]">
                {% if not project['image_data'] %}
                    <div class="bg-gray-700 w-full h-full grid place-items-center">
                        <img width="300"
                             height="300"
                             class="rounded-[5px]"
                             src="{{ url_for('static', filename='logo.svg') }}"
                             alt="hookneedle logo because no image available" />
                    </div>
                {% else %}
                    <img width="300"
                         height="300"
                         class="rounded-[5px]"
                         src="{{ project['image_data'] }}"
                         alt="image of {{ project['name'] }}" />
                {% endif %}
            </div>
            {% if project['link'] %}<a class="button ms-0" href="{{ project['link'] }}">Link to Pattern</a>{% endif %}
            {% if project['upload_data'] %}
                <a href="{{ project['upload_data'] }}"
                   target="_blank"
                   id="pattern-dwnld"
                   class="button">Open Pattern</a>
            {% endif %}
        </div>
        <div class="flex flex-col gap-4">
            <div>
                <h2>Description</h2>
                {% if project['desc_small'] %}
                    <p>{{ project['desc_small'] }}</p>
                {% else %}
                    <p>n/a</p>
                {% endif %}
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 border border-black p-4 rounded-[5px] h-min gap-y-4">
                <div class="flex flex-col">
                    <h3>Craft</h3>
                    <div>{{ project['which_craft'] }}</div>
                </div>
                <div class="flex flex-col">
                    {% if project['which_craft'] == 'crochet' %}
                        <h3>Hook size(s)</h3>
                    {% else %}
                        <h3>Needle size(s)</h3>
                    {% endif %}
                    {% if project['hook_needle_size'] %}
                        <div>{{ project['hook_needle_size'] }}</div>
                    {% else %}
                        <div>n/a</div>
                    {% endif %}
                </div>
                <div class="flex flex-col">
                    <h3>Yarn Weight</h3>
                    {% if project['yarn_weight'] %}
                        <div>{{ project['yarn_weight'] }}</div>
                    {% else %}
                        <div>n/a</div>
                    {% endif %}
                </div>
                <div class="grid place-items-center gap-2 w-full py-4 md:col-span-3 md:m-auto bg-[#2C262C]">
                    <h3>Progress</h3>
                    <progress title="project progress"
                              class="progress"
                              value="{{ project['progress'] }}"
                              max="100"></progress>
                </div>
                <div class="flex flex-col">
                    <h3>Status</h3>
                    {% if project['status'] %}
                        <div>
                            {% for word in (project['status'].split("-")) %}
                                {{ word + '
                                ' }}
                            {% endfor %}
                        </div>
                    {% else %}
                        <div>n/a</div>
                    {% endif %}
                </div>
                <div class="flex flex-col">
                    <h3>Start Date</h3>
                    {% if project['start_date'] %}
                        {% set date = project['start_date'].split("-") %}
                        <div>{{ date[1] + "-" + date[2] + "-" + date[0] }}</div>
                    {% else %}
                        <div>n/a</div>
                    {% endif %}
                </div>
                <div class="flex flex-col">
                    <h3>Goal End Date</h3>
                    {% if project['end_date'] %}
                        {% set date = project['end_date'].split("-") %}
                        <div>{{ date[1] + "-" + date[2] + "-" + date[0] }}</div>
                    {% else %}
                        <div>n/a</div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% if g.user['id'] == project['user_id'] %}
            <div>
                <div class="flex flex-col gap-4">
                    <div class="flex flex-col gap-4 @sm:justify-self-end border-1 border-black h-fit p-4 rounded-[5px]">
                        <div class="flex justify-between">
                            <div class="flex flex-col">
                                <h3>Plan</h3>
                                <hr class="w-full" />
                                <div id="days-left"></div>
                            </div>
                            <a href="/plan/edit">Edit</a>
                        </div>
                        <div>
                            <h3>Daily Goal</h3>
                            <p>n/a</p>
                        </div>
                        <div>
                            <h3>Weekly Goal</h3>
                            <p>n/a</p>
                        </div>
                    </div>
                    <div class="flex flex-col items-center @sm:justify-self-end border-1 border-black h-fit p-4 rounded-[5px]">
                        <h3 class="title text-center">Timer</h3>
                        <p class="timerStatus text-center mb-4">It's focus time!</p>
                        <p id="timer" class="text-4xl text-center mb-4">00:00</p>
                        <div class="flex gap-2 items-strech w-min">
                            <input class="minutes w-[60px] focus:outline-4 focus:outline-[#66e466] bg-[#dadada] border border-black rounded-[5px] text-xl text-black ps-2 py-1"
                                   type="number" />
                            <button class="timerBtn button !my-0">Start</button>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <h2 class="mb-2">Notes</h2>
                <div class="text-[rgb(var(--text-color))] fill-[rgb(var(--text-color))]">
                    <div id="editor"
                         class="bg-[rgb(var(--bkgd-color))] text-[rgb(var(--text-color))]"></div>
                </div>
                <div class="flex gap-6 items-center">
                    <button class="button" id="save-btn" type="submit">Save Note</button>
                    <div id="save-message" class="text-green-500"></div>
                </div>
            </div>
        {% endif %}
    </div>
    <script>
        let projectId = "{{ project['id'] }}";
        let startDate = "{{ project['start_date'] }}";
        let endDate = "{{ project['end_date'] }}";

        let loggedInUserId = "{{g.user['id']}}";
        let userId = "{{project['user_id']}}";

        if (loggedInUserId == userId) {
            if (startDate && endDate) {
                let daysLeft = document.querySelector('#days-left');
                let start = new Date(startDate);
                let end = new Date(endDate);
                diff = Math.abs((start - end) / (1000 * 60 * 60 * 24));
                daysLeft.textContent = `${diff} days left`;
            }

            const quill = new Quill('#editor', {
                modules: {
                    toolbar: true,
                    keyboard: {
                        bindings: {
                            tab: false,
                        },
                    },
                },
                theme: 'snow',
            });

            let getNote = async () => {
                try {
                    const response = await fetch(`/note/${projectId}`);
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }
                    const res = await response.json();
                    quill.setContents(res);
                } catch (error) {
                    console.error(error.message);
                }
            };

            getNote();

            document
                .querySelector('#save-btn')
                .addEventListener('click', async () => {
                    let delta = quill.getContents();

                    fetch(`/note/${projectId}/create`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(delta),
                        })
                        .then(
                            () =>
                            (document.querySelector(
                                '#save-message'
                            ).textContent = 'Note Saved!')
                        )
                        .catch((error) =>
                            console.error('CAUGHT ERROR ON POST', error)
                        );

                    setTimeout(() => {
                        document.querySelector('#save-message').textContent = '';
                    }, 2000);
                });

            document
                .querySelector('#delete-btn')
                ?.addEventListener('click', async () => {
                    if (confirm('Are you sure you want to delete this project?')) {
                        fetch(`/project/delete/${projectId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-type': 'application/json; charset=UTF-8',
                                },
                            })
                            .then((res) => res.json())
                            .then((data) => {
                                if (data == 'project successfully deleted') {
                                    window.location.replace('/');
                                }
                            })
                            .catch((error) =>
                                console.error('CAUGHT ERROR ON DELETE', error)
                            );
                    }
                });

            timerTitle = document.querySelector('.title');
            timer = document.querySelector('#timer');
            timerBtn = document.querySelector('.timerBtn');
            timerStatus = document.querySelector('.timerStatus');
            alarm = new Audio("{{ url_for('static', filename='alarm.mp3') }}");
            ogColor = '#b4b4b4'
            logoColor = '#66e466'

            let myTimer;
            let minutes;

            let startTimer = () => {
                timerTitle.textContent = `${minutes} min timer`;
                myTimer = setInterval(incrementTime, 1000);
            };

            let stopTimer = () => {
                console.log('stopping timer');
                clearInterval(myTimer);
            };

            let resetTimer = () => {
                timer.textContent = '00:00';
                timerTitle.textContent = `Timer`;
                timerStatus.textContent = "It's focus time!";
                timerStatus.style.color = ogColor;
                timer.style.color = ogColor;
            };

            let pad = (num) => {
                return num < 10 ? '0' + num : num;
            };

            let incrementTime = () => {
                let minSec = timer.textContent.split(':');
                let min = +minSec[0];
                let sec = +minSec[1];

                if (sec < 59) {
                    sec++;
                } else {
                    min++;
                    sec = 0;
                }

                if (min == minutes) {
                    timerStatus.textContent = 'TIME IS UP!!';
                    timerStatus.style.color = logoColor;
                    timer.style.color = logoColor;
                    alarm.play().then(() => {
                        stopTimer();
                        setTimeout(() => {
                            resetTimer();
                            timerBtn.textContent = 'Start';
                        }, 2000)
                    });
                }

                timer.textContent = `${pad(min)}:${pad(sec)}`;
            };

            timerBtn.addEventListener('click', () => {
                if (timerBtn.textContent == 'Start') {
                    minutes = +document.querySelector('.minutes').value;
                    startTimer();
                    timerBtn.textContent = 'Stop';
                } else {
                    stopTimer();
                    resetTimer();
                    timerBtn.textContent = 'Start';
                }
            });
        }
    </script>
{% endblock %}
